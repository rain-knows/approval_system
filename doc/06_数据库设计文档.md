# 审批系统 - 数据库设计文档

## 1. 数据库概述

| 项目 | 说明 |
|------|------|
| 数据库 | MySQL 8.0 |
| 字符集 | utf8mb4 |
| 排序规则 | utf8mb4_general_ci |
| 存储引擎 | InnoDB |

## 2. 数据表总览

| 序号 | 表名 | 中文名称 | 说明 |
|------|------|----------|------|
| 1 | sys_user | 用户表 | 系统用户信息 |
| 2 | sys_department | 部门表 | 组织架构管理 |
| 3 | approval_type | 审批类型表 | 审批业务分类 |
| 4 | workflow_template | 工作流模板表 | 审批流程模板配置 |
| 5 | workflow_node_template | 工作流节点模板表 | 流程节点配置 |
| 6 | approval_record | 审批记录表 | 审批申请主表 |
| 7 | approval_node | 审批节点表 | 审批流程实例节点 |
| 8 | attachment | 附件表 | 文件附件管理 |
| 9 | notification | 通知表 | 系统通知消息 |
| 10 | operation_log | 操作日志表 | 系统操作审计 |

---

## 3. 数据表详细设计

### 3.1 用户表 (sys_user)

存储系统用户基本信息，包含认证、角色和状态管理。

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | PK, AUTO_INCREMENT | - | 用户ID |
| username | VARCHAR(50) | NOT NULL, UNIQUE | - | 用户名（登录账号） |
| password | VARCHAR(100) | NOT NULL | - | 密码（BCrypt加密） |
| nickname | VARCHAR(50) | NOT NULL | - | 昵称（显示名称） |
| email | VARCHAR(100) | - | NULL | 邮箱地址 |
| phone | VARCHAR(20) | - | NULL | 手机号 |
| avatar | VARCHAR(255) | - | NULL | 头像文件路径 |
| department_id | BIGINT | FK | NULL | 所属部门ID |
| role | VARCHAR(20) | NOT NULL | 'USER' | 角色: USER/ADMIN/SUPER_ADMIN |
| status | TINYINT | NOT NULL | 1 | 状态: 0-禁用 1-启用 |
| last_login_at | DATETIME | - | NULL | 最后登录时间 |
| last_login_ip | VARCHAR(50) | - | NULL | 最后登录IP |
| created_at | DATETIME | - | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- `idx_username` (username) - 用户名查询
- `idx_role` (role) - 角色筛选
- `idx_department` (department_id) - 部门查询

---

### 3.2 部门表 (sys_department)

存储组织架构信息，支持树形结构。

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | PK, AUTO_INCREMENT | - | 部门ID |
| name | VARCHAR(100) | NOT NULL | - | 部门名称 |
| parent_id | BIGINT | - | 0 | 父部门ID（0表示顶级部门） |
| leader_id | BIGINT | FK | NULL | 部门负责人ID |
| sort_order | INT | - | 0 | 排序序号 |
| status | TINYINT | NOT NULL | 1 | 状态: 0-禁用 1-启用 |
| created_at | DATETIME | - | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- `idx_parent` (parent_id) - 子部门查询

---

### 3.3 审批类型表 (approval_type)

定义审批业务类型分类。

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | PK, AUTO_INCREMENT | - | 类型ID |
| code | VARCHAR(50) | NOT NULL, UNIQUE | - | 类型编码（如LEAVE/EXPENSE） |
| name | VARCHAR(100) | NOT NULL | - | 类型名称 |
| description | VARCHAR(500) | - | NULL | 类型描述 |
| icon | VARCHAR(50) | - | NULL | 图标名称 |
| color | VARCHAR(20) | - | NULL | 主题颜色 |
| sort_order | INT | - | 0 | 排序序号 |
| status | TINYINT | NOT NULL | 1 | 状态: 0-禁用 1-启用 |
| created_at | DATETIME | - | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

---

### 3.4 工作流模板表 (workflow_template)

存储可配置的审批流程模板。

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | PK, AUTO_INCREMENT | - | 模板ID |
| name | VARCHAR(100) | NOT NULL | - | 模板名称 |
| type_code | VARCHAR(50) | NOT NULL, FK | - | 关联审批类型编码 |
| description | VARCHAR(500) | - | NULL | 模板描述 |
| status | TINYINT | NOT NULL | 1 | 状态: 0-禁用 1-启用 |
| created_by | BIGINT | NOT NULL, FK | - | 创建人ID |
| created_at | DATETIME | - | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- `idx_type_code` (type_code) - 类型关联查询
- `idx_status` (status) - 状态筛选

---

### 3.5 工作流节点模板表 (workflow_node_template)

定义工作流模板中的审批节点配置。

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | PK, AUTO_INCREMENT | - | 节点模板ID |
| workflow_id | BIGINT | NOT NULL, FK | - | 工作流模板ID |
| node_name | VARCHAR(100) | NOT NULL | - | 节点名称（如：直属上级） |
| node_order | INT | NOT NULL | - | 节点顺序 |
| approver_type | VARCHAR(20) | NOT NULL | - | 审批人类型: ROLE/USER/DEPARTMENT_HEAD |
| approver_id | BIGINT | - | NULL | 指定审批人ID |
| created_at | DATETIME | - | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- `idx_workflow` (workflow_id) - 关联查询
- `uk_workflow_order` (workflow_id, node_order) - 唯一约束

---

### 3.6 审批记录表 (approval_record)

存储审批申请主记录。

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | VARCHAR(36) | PK | - | 审批ID (UUID) |
| title | VARCHAR(200) | NOT NULL | - | 审批标题 |
| type_code | VARCHAR(50) | NOT NULL, FK | - | 审批类型编码 |
| content | TEXT | - | NULL | 审批内容（支持JSON） |
| initiator_id | BIGINT | NOT NULL, FK | - | 发起人ID |
| priority | TINYINT | - | 0 | 紧急程度: 0-普通 1-紧急 2-非常紧急 |
| deadline | DATETIME | - | NULL | 截止日期 |
| status | TINYINT | NOT NULL | 0 | 状态码（见状态枚举） |
| current_node_order | INT | - | 1 | 当前审批节点序号 |
| workflow_id | BIGINT | FK | NULL | 使用的工作流模板ID |
| created_at | DATETIME | - | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | ON UPDATE CURRENT_TIMESTAMP | 更新时间 |
| completed_at | DATETIME | - | NULL | 完成时间 |

**索引**:
- `idx_initiator` (initiator_id) - 发起人查询
- `idx_type` (type_code) - 类型筛选
- `idx_status` (status) - 状态筛选
- `idx_created_at` (created_at) - 时间排序

---

### 3.7 审批节点表 (approval_node)

存储审批流程实例的各节点状态。

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | PK, AUTO_INCREMENT | - | 节点ID |
| approval_id | VARCHAR(36) | NOT NULL, FK | - | 审批记录ID |
| node_name | VARCHAR(100) | NOT NULL | - | 节点名称 |
| approver_id | BIGINT | NOT NULL, FK | - | 审批人ID |
| node_order | INT | NOT NULL | - | 节点顺序 |
| status | TINYINT | NOT NULL | 0 | 状态: 0-待审批 1-已通过 2-已拒绝 |
| comment | VARCHAR(500) | - | NULL | 审批意见 |
| approved_at | DATETIME | - | NULL | 审批时间 |
| created_at | DATETIME | - | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- `idx_approval_id` (approval_id) - 关联查询
- `idx_approver` (approver_id) - 审批人查询
- `uk_approval_order` (approval_id, node_order) - 唯一约束

---

### 3.8 附件表 (attachment)

存储审批相关的文件附件信息。

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | VARCHAR(36) | PK | - | 附件ID (UUID) |
| approval_id | VARCHAR(36) | FK | NULL | 关联审批ID |
| original_name | VARCHAR(255) | NOT NULL | - | 原始文件名 |
| stored_name | VARCHAR(255) | NOT NULL | - | 存储文件名 |
| file_path | VARCHAR(500) | NOT NULL | - | 文件存储路径 |
| file_size | BIGINT | NOT NULL | - | 文件大小（字节） |
| file_type | VARCHAR(50) | - | NULL | 文件类型（pdf/docx/xlsx等） |
| mime_type | VARCHAR(100) | - | NULL | MIME 类型 |
| preview_support | TINYINT | - | 0 | 是否支持在线预览: 0-不支持 1-支持 |
| uploader_id | BIGINT | NOT NULL, FK | - | 上传者ID |
| created_at | DATETIME | - | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- `idx_approval_id` (approval_id) - 关联查询
- `idx_uploader` (uploader_id) - 上传者查询

---

### 3.9 通知表 (notification)

存储系统通知消息。

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | VARCHAR(36) | PK | - | 通知ID (UUID) |
| user_id | BIGINT | NOT NULL, FK | - | 接收用户ID |
| title | VARCHAR(200) | NOT NULL | - | 通知标题 |
| content | VARCHAR(500) | - | NULL | 通知内容 |
| type | VARCHAR(20) | NOT NULL | - | 通知类型: APPROVAL/SYSTEM/REMINDER |
| related_id | VARCHAR(36) | - | NULL | 关联业务ID |
| is_read | TINYINT | NOT NULL | 0 | 是否已读: 0-未读 1-已读 |
| read_at | DATETIME | - | NULL | 阅读时间 |
| created_at | DATETIME | - | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- `idx_user_id` (user_id) - 用户查询
- `idx_user_read` (user_id, is_read) - 未读通知查询
- `idx_created_at` (created_at) - 时间排序

---

### 3.10 操作日志表 (operation_log)

记录系统操作日志，用于审计追踪。

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | PK, AUTO_INCREMENT | - | 日志ID |
| user_id | BIGINT | NOT NULL | - | 操作用户ID |
| module | VARCHAR(50) | NOT NULL | - | 模块名称 |
| operation | VARCHAR(50) | NOT NULL | - | 操作类型 |
| target_id | VARCHAR(36) | - | NULL | 目标业务ID |
| detail | TEXT | - | NULL | 操作详情 |
| ip_address | VARCHAR(50) | - | NULL | 客户端IP地址 |
| user_agent | VARCHAR(500) | - | NULL | 用户代理信息 |
| created_at | DATETIME | - | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- `idx_user_id` (user_id) - 用户操作查询
- `idx_module` (module) - 模块筛选
- `idx_created_at` (created_at) - 时间范围查询

---

## 4. ER 关系图

```
┌─────────────────┐                         ┌─────────────────┐
│  sys_department │                         │    sys_user     │
├─────────────────┤                         ├─────────────────┤
│ id (PK)         │◄────────────────────────│ department_id   │
│ name            │                         │ id (PK)         │
│ parent_id       │                         │ username (UK)   │
│ leader_id (FK)  │─────────────────────────│                 │
└─────────────────┘                         │ nickname        │
                                            │ role            │
                                            └─────────────────┘
                                                   │
         ┌─────────────────────────────────────────┼─────────────────────────┐
         │                                         │                         │
         ▼                                         ▼                         ▼
┌─────────────────┐                    ┌───────────────────────┐    ┌─────────────────┐
│ approval_record │                    │   workflow_template   │    │  notification   │
├─────────────────┤                    ├───────────────────────┤    ├─────────────────┤
│ id (PK/UUID)    │                    │ id (PK)               │    │ id (PK/UUID)    │
│ initiator_id(FK)│◄───────────────────│ created_by (FK)       │    │ user_id (FK)    │
│ type_code (FK)  │────────┐           │ type_code (FK)        │──┐ │ title           │
│ workflow_id(FK) │────────│───────────│────────────────       │  │ │ type            │
│ status          │        │           └───────────────────────┘  │ │ related_id      │
└─────────────────┘        │                      │               │ └─────────────────┘
        │                  │                      ▼               │
        │                  │           ┌──────────────────────────┤
        ▼                  │           │ workflow_node_template   │
┌─────────────────┐        │           ├──────────────────────────┤
│  approval_node  │        │           │ id (PK)                  │
├─────────────────┤        │           │ workflow_id (FK)         │
│ id (PK)         │        │           │ node_name                │
│ approval_id(FK) │        │           │ node_order               │
│ approver_id(FK) │        │           └──────────────────────────┘
│ node_name       │        │
│ status          │        │           ┌─────────────────┐
└─────────────────┘        │           │  approval_type  │
                           │           ├─────────────────┤
        │                  └──────────▶│ code (UK)       │
        ▼                              │ id (PK)         │
┌─────────────────┐                    │ name            │
│   attachment    │                    └─────────────────┘
├─────────────────┤
│ id (PK/UUID)    │                    ┌─────────────────┐
│ approval_id(FK) │                    │  operation_log  │
│ uploader_id(FK) │                    ├─────────────────┤
│ original_name   │                    │ id (PK)         │
│ preview_support │                    │ user_id         │
└─────────────────┘                    │ module          │
                                       │ operation       │
                                       └─────────────────┘
```

---

## 5. 状态枚举定义

### 5.1 审批记录状态 (approval_record.status)

| 值 | 常量名 | 中文名称 | 说明 |
|----|--------|----------|------|
| 0 | DRAFT | 草稿 | 未提交的审批草稿 |
| 1 | PENDING | 待审批 | 已提交，等待第一个节点审批 |
| 2 | IN_PROGRESS | 审批中 | 多节点流程进行中 |
| 3 | APPROVED | 已通过 | 所有节点审批通过 |
| 4 | REJECTED | 已拒绝 | 任一节点拒绝 |
| 5 | WITHDRAWN | 已撤回 | 发起人主动撤回 |

### 5.2 审批节点状态 (approval_node.status)

| 值 | 常量名 | 中文名称 | 说明 |
|----|--------|----------|------|
| 0 | PENDING | 待审批 | 等待该节点审批 |
| 1 | APPROVED | 已通过 | 该节点审批通过 |
| 2 | REJECTED | 已拒绝 | 该节点审批拒绝 |

### 5.3 审批人类型 (workflow_node_template.approver_type)

| 值 | 说明 |
|----|------|
| USER | 指定用户审批 |
| ROLE | 指定角色审批 |
| DEPARTMENT_HEAD | 部门负责人审批 |

### 5.4 通知类型 (notification.type)

| 值 | 说明 |
|----|------|
| APPROVAL | 审批相关通知 |
| SYSTEM | 系统公告通知 |
| REMINDER | 提醒类通知 |

### 5.5 审批优先级 (approval_record.priority)

| 值 | 说明 |
|----|------|
| 0 | 普通 |
| 1 | 紧急 |
| 2 | 非常紧急 |

---

## 6. 初始化数据

### 6.1 审批类型初始数据

```sql
INSERT INTO approval_type (code, name, description, icon, color) VALUES
('LEAVE', '请假申请', '员工请假审批', 'calendar', '#3B82F6'),
('EXPENSE', '报销申请', '费用报销审批', 'dollar-sign', '#10B981'),
('PURCHASE', '采购申请', '物品采购审批', 'shopping-cart', '#8B5CF6'),
('BUSINESS_TRIP', '出差申请', '出差行程审批', 'plane', '#F59E0B'),
('OVERTIME', '加班申请', '加班时间审批', 'clock', '#EF4444'),
('OTHER', '其他申请', '其他类型审批', 'file-text', '#6B7280');
```

### 6.2 管理员账号

```sql
-- 密码: admin123 (BCrypt加密)
INSERT INTO sys_user (username, password, nickname, role, status) VALUES
('admin', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iAt6Z5EH', '系统管理员', 'SUPER_ADMIN', 1);
```

---

## 7. 数据库脚本

完整的数据库初始化脚本请参见：[script/init_database.sql](../script/init_database.sql)
